name: Server Health Check

on:
  schedule:
    # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼æ¸¬è©¦

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: æª¢æŸ¥ä¼ºæœå™¨å¥åº·ç‹€æ…‹
        id: check_status
        run: |
          # å‘¼å«å¥åº·æª¢æŸ¥ç«¯é»ä¸¦å–å¾—å®Œæ•´å›æ‡‰
          RESPONSE=$(curl -s --max-time 15 "${{ secrets.SERVER_URL }}/health" -w "\n%{http_code}")
          
          # åˆ†é›¢ HTTP ç‹€æ…‹ç¢¼å’Œå›æ‡‰å…§å®¹
          STATUS_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Status Code: $STATUS_CODE"
          echo "Response Body: $BODY"
          
          # è¼¸å‡ºåˆ° GitHub Actions è®Šæ•¸
          echo "status_code=$STATUS_CODE" >> $GITHUB_OUTPUT
          echo "response_body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # è§£æ JSON å›æ‡‰ï¼ˆéœ€è¦ jqï¼‰
          if [ "$STATUS_CODE" -eq 200 ] || [ "$STATUS_CODE" -eq 503 ]; then
            OVERALL_STATUS=$(echo "$BODY" | jq -r '.status // "unknown"')
            OVERALL_HEALTHY=$(echo "$BODY" | jq -r '.overall_healthy // false')
            
            echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
            echo "overall_healthy=$OVERALL_HEALTHY" >> $GITHUB_OUTPUT
            
            # æª¢æŸ¥å„é …æœå‹™ç‹€æ…‹
            DB_STATUS=$(echo "$BODY" | jq -r '.checks.database.status // "unknown"')
            FINMIND_STATUS=$(echo "$BODY" | jq -r '.checks.finmind_api.status // "unknown"')
            FUGLE_STATUS=$(echo "$BODY" | jq -r '.checks.fugle_api.status // "unknown"')
            SYNC_STATUS=$(echo "$BODY" | jq -r '.checks.last_sync.status // "unknown"')
            RESOURCE_STATUS=$(echo "$BODY" | jq -r '.checks.resources.status // "unknown"')
            
            echo "db_status=$DB_STATUS" >> $GITHUB_OUTPUT
            echo "finmind_status=$FINMIND_STATUS" >> $GITHUB_OUTPUT
            echo "fugle_status=$FUGLE_STATUS" >> $GITHUB_OUTPUT
            echo "sync_status=$SYNC_STATUS" >> $GITHUB_OUTPUT
            echo "resource_status=$RESOURCE_STATUS" >> $GITHUB_OUTPUT
            
            # å¦‚æœæ•´é«”ç‹€æ…‹ç‚º unhealthyï¼Œè¦–ç‚ºå¤±æ•—
            if [ "$OVERALL_STATUS" = "unhealthy" ]; then
              echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—ï¼šç³»çµ±ç‹€æ…‹ç‚º unhealthy"
              exit 1
            fi
            
            # å¦‚æœç‹€æ…‹ç‚º degradedï¼Œç™¼å‡ºè­¦å‘Šä½†ä¸å¤±æ•—
            if [ "$OVERALL_STATUS" = "degraded" ]; then
              echo "âš ï¸ å¥åº·æª¢æŸ¥è­¦å‘Šï¼šç³»çµ±ç‹€æ…‹ç‚º degraded"
              echo "is_degraded=true" >> $GITHUB_OUTPUT
            fi
          else
            # HTTP ç‹€æ…‹ç¢¼ç•°å¸¸
            echo "âŒ HTTP ç‹€æ…‹ç¢¼ç•°å¸¸: $STATUS_CODE"
            exit 1
          fi

      - name: ç™¼é€ Telegram å‘Šè­¦é€šçŸ¥ (Unhealthy)
        if: failure()
        run: |
          # çµ„åˆè©³ç´°çš„å‘Šè­¦è¨Šæ¯
          MESSAGE="ğŸš¨ *ä¸»æ©Ÿå¥åº·æª¢æŸ¥å¤±æ•—* ğŸš¨%0A%0A"
          MESSAGE="${MESSAGE}*æœå‹™*ï¼šStock Bot%0A"
          MESSAGE="${MESSAGE}*ç‹€æ…‹*ï¼š${{ steps.check_status.outputs.overall_status || 'ç„¡æ³•é€£ç·š' }}%0A"
          MESSAGE="${MESSAGE}*HTTP ç‹€æ…‹ç¢¼*ï¼š${{ steps.check_status.outputs.status_code || '000' }}%0A"
          MESSAGE="${MESSAGE}*æ™‚é–“*ï¼š$(date '+%Y-%m-%d %H:%M:%S') (UTC)%0A%0A"
          
          # å¦‚æœæœ‰è©³ç´°ç‹€æ…‹è³‡è¨Šï¼ŒåŠ å…¥å„é …æª¢æŸ¥çµæœ
          if [ -n "${{ steps.check_status.outputs.db_status }}" ]; then
            MESSAGE="${MESSAGE}*å„é …æª¢æŸ¥ç‹€æ…‹*ï¼š%0A"
            MESSAGE="${MESSAGE}â€¢ è³‡æ–™åº«ï¼š${{ steps.check_status.outputs.db_status }}%0A"
            MESSAGE="${MESSAGE}â€¢ Finmind APIï¼š${{ steps.check_status.outputs.finmind_status }}%0A"
            MESSAGE="${MESSAGE}â€¢ Fugle APIï¼š${{ steps.check_status.outputs.fugle_status }}%0A"
            MESSAGE="${MESSAGE}â€¢ åŒæ­¥ç‹€æ…‹ï¼š${{ steps.check_status.outputs.sync_status }}%0A"
            MESSAGE="${MESSAGE}â€¢ ç³»çµ±è³‡æºï¼š${{ steps.check_status.outputs.resource_status }}%0A"
          fi
          
          MESSAGE="${MESSAGE}%0Aè«‹ç«‹å³æª¢æŸ¥ä¼ºæœå™¨ï¼"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"

      - name: ç™¼é€ Telegram è­¦å‘Šé€šçŸ¥ (Degraded)
        if: success() && steps.check_status.outputs.is_degraded == 'true'
        run: |
          # çµ„åˆé™ç´šè­¦å‘Šè¨Šæ¯
          MESSAGE="âš ï¸ *ä¸»æ©Ÿå¥åº·æª¢æŸ¥è­¦å‘Š* âš ï¸%0A%0A"
          MESSAGE="${MESSAGE}*æœå‹™*ï¼šStock Bot%0A"
          MESSAGE="${MESSAGE}*ç‹€æ…‹*ï¼šdegraded (éƒ¨åˆ†æœå‹™é™ç´š)%0A"
          MESSAGE="${MESSAGE}*æ™‚é–“*ï¼š$(date '+%Y-%m-%d %H:%M:%S') (UTC)%0A%0A"
          MESSAGE="${MESSAGE}*å„é …æª¢æŸ¥ç‹€æ…‹*ï¼š%0A"
          MESSAGE="${MESSAGE}â€¢ è³‡æ–™åº«ï¼š${{ steps.check_status.outputs.db_status }}%0A"
          MESSAGE="${MESSAGE}â€¢ Finmind APIï¼š${{ steps.check_status.outputs.finmind_status }}%0A"
          MESSAGE="${MESSAGE}â€¢ Fugle APIï¼š${{ steps.check_status.outputs.fugle_status }}%0A"
          MESSAGE="${MESSAGE}â€¢ åŒæ­¥ç‹€æ…‹ï¼š${{ steps.check_status.outputs.sync_status }}%0A"
          MESSAGE="${MESSAGE}â€¢ ç³»çµ±è³‡æºï¼š${{ steps.check_status.outputs.resource_status }}%0A"
          MESSAGE="${MESSAGE}%0Aç³»çµ±ä»å¯é‹ä½œï¼Œä½†å»ºè­°æª¢æŸ¥é™ç´šçš„æœå‹™ã€‚"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"
