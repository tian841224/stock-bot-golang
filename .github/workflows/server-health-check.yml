name: Server Health Check

on:
  schedule:
    # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼æ¸¬è©¦

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: é€é SSH æª¢æŸ¥ä¸»æ©Ÿå…§éƒ¨å¥åº·ç‹€æ…‹
        id: check_status
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # åœ¨ä¸»æ©Ÿå…§éƒ¨å‘¼å« localhost
            # å˜—è©¦å‘¼å«ä¸»æœå‹™ (8080)
            RESPONSE=$(curl -s --max-time 10 "http://localhost:8080/health" -w "\n%{http_code}")
            
            # åˆ†é›¢ç‹€æ…‹ç¢¼å’Œå›æ‡‰å…§å®¹
            STATUS_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "::set-output name=status_code::$STATUS_CODE"
            
            # æª¢æŸ¥çµæœ
            if [ "$STATUS_CODE" -eq 200 ] || [ "$STATUS_CODE" -eq 503 ]; then
              # ä½¿ç”¨ jq è§£æ (å‡è¨­ä¸»æ©Ÿæœ‰å®‰è£ jqï¼Œè‹¥ç„¡å‰‡æ”¹ç”¨ grep ç°¡å–®åˆ¤æ–·)
              if command -v jq &> /dev/null; then
                  OVERALL_STATUS=$(echo "$BODY" | jq -r '.status // "unknown"')
                  echo "::set-output name=overall_status::$OVERALL_STATUS"
                  
                  # è¼¸å‡ºè©³ç´°è³‡è¨Šä¾›ä¸‹ä¸€æ­¥é€šçŸ¥ä½¿ç”¨ (é€™è£¡ç°¡åŒ–è¼¸å‡ºï¼Œå¯¦éš›é€šçŸ¥é‚è¼¯å¯ä¾éœ€æ±‚å¢å¼·)
                  echo "Checking dependencies..."
                  echo "DB: $(echo "$BODY" | jq -r '.checks.database.status')"
              else
                  # Fallback: ä½¿ç”¨ grep ç°¡å–®åˆ¤æ–·
                  if echo "$BODY" | grep -q '"status":"healthy"'; then
                      echo "::set-output name=overall_status::healthy"
                  else
                      echo "::set-output name=overall_status::unhealthy"
                  fi
              fi
            else
              echo "::set-output name=overall_status::unhealthy"
              echo "HTTP Status Code: $STATUS_CODE"
              exit 1
            fi

      - name: ç™¼é€ Telegram å‘Šè­¦é€šçŸ¥ (Unhealthy)
        if: failure()
        run: |
          # çµ„åˆå‘Šè­¦è¨Šæ¯ (ç°¡åŒ–ç‰ˆ)
          MESSAGE="ğŸš¨ *ä¸»æ©Ÿå¥åº·æª¢æŸ¥å¤±æ•— (SSHå…§éƒ¨æª¢æŸ¥)* ğŸš¨%0A%0A"
          MESSAGE="${MESSAGE}*æœå‹™*ï¼šStock Bot%0A"
          MESSAGE="${MESSAGE}*æª¢æŸ¥æ–¹å¼*ï¼šSSH -> Localhost%0A"
          MESSAGE="${MESSAGE}*æ™‚é–“*ï¼š$(date '+%Y-%m-%d %H:%M:%S') (UTC)%0A%0A"
          MESSAGE="${MESSAGE}è«‹ç«‹å³ç™»å…¥ä¸»æ©Ÿæª¢æŸ¥ Docker å®¹å™¨ç‹€æ…‹ï¼"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"
